## [基础网络概念](http://linux.vbird.org/linux_server/0110network_basic.php#whatisnetwork_comps)

### 2.1 网络是个什么玩意

这个标准是由国际组织规范的，你的系统里面只要提供符合该标准的程序代码，那你就能够通过这个标准和其他系统进行沟通。

#### 2.1.1 什么是网络



除了硬件之外，TCP/IP这个Internet的通讯协议也是有标准的，这些标准大部分都以RFC（Request For Comments）的形式发布标准文件。通过这些文件的辅助，任何人只要会写程序的话，就有可能发展出自己的TCP/IP软件，并且连接上Internet。早期的linux为了要连上Internet，Linux团队就自己编写出TCP/IP的代码，通过这些基础文件的标准依据。举例来说RFC 1122这个建议文件就指出一些可以连线到Internet的主机应该要注意的相关协议与基本要求，让想要编写连线程序的设计师可以有一个指引的标准方向。

集线器（hub）不是节点，因为它不具有IP。

网关：具有两个以上的网卡界面，可以连接两个以上不同的网段的设备，例如IP分享器就是一个常见的网关设备。那上面的ADSL数据机算不算网关呢？其实不太能算，因为数据机通常视为一个在主机内的网卡设备，我们可以在一般PC上面通过拨号软件，将数据机模拟成为一张实体网卡（ppp），因此不太能算网关设备。

#### 2.1.4 电脑网络通讯协议： OSI七层协议

其中比较特殊的是第二层，因为第二层（数据链路层）主要是位于软件封包以及硬件frame中间的一个阶层，它必须要将软件包装的包裹放入到硬件能够处理的包裹中，因此这个阶层又分为两个子层在处理相对应的资料。因为比较特殊，所以第二层的数据格式尾部还会出现一个检查码。

每一层负责的任务：

|     分层      |                           负责内容                           |
| :-----------: | :----------------------------------------------------------: |
| 第一层 实体层 | 由于网络媒体只能传送0和1这样的内容，因此实体层必须定义所使用的的媒体设备的电压和信号等，同时还必须了解数据帧转换成0/1的编码方式，最后连接实体媒体并传送/接收0/1 |
|  数据链路层   | 这一层是比较特殊的一个阶层，因为底下是实体的定义，而上层是软件封装的定义。因为第二层又分两个子层在进行数据的转换动作。在偏硬件的部分，主要负责的是MAC（Media Access Control），我们称这个数据包为MAC帧，MAC是网络媒体所能处理的主要数据包，这也是最终被实体层编码成01的数据。MAC必须经由通讯协议来取得媒体的使用权。目前最常使用的是IEEE 802.3的以太网协议。  至于偏软件的部分则是由逻辑链路层（logical link control, LLC）所控制，主要在多任务处理来自上层的数据包资料并转成MAC的格式，负责的工作包括信息交换，流量控制，失误问题的处理等等。 |
|    网络层     | 这一层是我们最感兴趣的，因为我们提及的IP就是在这一层定义的。同时也定义出电脑之间的连线建立、终止与维持等等，数据包的传输路径选择等等，因此这个层级当中最重要的除了IP之外，就是数据包等否到达目的地的路由概念了。 |
|    传输层     | 这一层定义了发送端和接收端的连接技术（如TCP，UDP），同时包括该技术的数据包格式，数据包的传送，流量控制，传输过程的检测检查和失败重传等等，以确保各个数据包可以正确无误的到达目的端 |
|    会话层     | 在这个层级中主要定义了两个地址之间的连线通道之连接和挂断，此外，也可建立应用程序的对话、提供其他加强型服务如网络管理，签到签退，对话控制等等。如果说传输层是在判断数据包是否可以正确的到达目标，那么会话层则是在确定网路服务建立连接的确认。 |
|    表现层     | 我们在应用程序上所制作出来的数据格式不一定符合网络传输的标准编码格式，所以在这个层级当中，主要的动作就是：将来自本地端应用程序的数据格式转换（或者是重新编码）称为网络的标准格式，然后再交给底下的传输层等协议来进行处理。所以在这个层级上主要定义的是网络服务（或程序）之间的数据格式的转换，包括数据的加密解密也是在这个层面上处理 |
|    应用层     | 应用层本身并不属于应用程序所有，而是在定义应用程序如何进入此层的沟通界面，以将数据接收或传送给应用程序，最终展示给使用者。 |

#### 2.1.5 电脑网络通讯协议： TCP/IP

应用层：

传输层：依据传送的可靠性又将数据包格式分为连接导向的TCP以及非连接导向的UDP数据包格式。

网络层：也没有改变，主要内容是提供了IP数据包，并可选择最佳路由来到达目标IP位置。

数据链路层和实体层整合为一个链路层，包括定义硬件信息，编码等，因此主要与硬件有关。

链路层：如果使用以太网络时，此时IP会依据CSMA/CD的标准，包裹到MAC数据帧中，并给予MAC表头，

网络媒体一次传输的数据量是有限的，因此如果要被传输的数据太大时，我们在分层的包装中，就得要将数据先拆开放到不同的包裹中，再给包裹一个序号，好让目的端的主机能够藉由这些序号再重新将数据整合回来。

> 一般来说，因为应用程序和开发工程师比较有关系，而网络层以下的数据则主要是由操作系统提供的，因此，我们又将TCP/IP当中的应用层视为使用者层，而底下的三层才是我们主要谈到的网络基础。

### 2.2 TCP/IP的链路层相关协议

TCP/IP最底层的链路层主要和硬件比较有关系，因此底下我们主要介绍一些WAN 和LAN 的硬件。同时会介绍CSMA/CD 的以太网络协议，以及相关的硬件与MAC数据帧等

#### 2.2.1 广域网使用的设备

#### 2.2.2 局域网使用的设备-以太网络

ADSL传输速度可以达到下行2Mbps/128Kbps(Kbits per second)，这里的Kb指的不是bytes而是bits。所以2M/128K 在实际的文件大小传输速度上，最大理论传输为256KBps/16KBps(KBytes per second), 所以正常下载的速度约在每秒100~200KBytes 之间。所以一般bps还要除以8才是Bps,

跳线：一边为568A 一边为568B的接头时称为跳线，用在直接连接两部主机的网卡。

平行线：两边接头同为568A或568B时称为平行线，用在连接主机网卡与集线器之间的线材。

#### 2.2.3 以太网络的传输协议： CSMA/CD

以太网络的传输主要就是网卡对网卡之间的数据传输。每张以太网卡出厂时，就会赋予一个独一无二的卡号，就是所谓的MAC（Media Access Control）.以太网络的网卡之间数据是通过CSMA/CD来传输的。

中心点为集线器，各个主机都是连线到集线器，然后通过集线器的功能向所有主机发起连线的。

网络共享媒体在单一时间点内，仅能被一部主机所使用。

1. 监听媒体使用情况：A主机要发送网络包前，先要对网络媒体进行监听，确认没人在用之后，才能发送出数据帧。
2. 多点传输： A主机所送出的数据会被集线器复制一份，然后传送给所有连接到此集线器的主机。
3. 碰撞检测：

既然共享媒体只有一个主机可以使用，为何大家可以同时上网？

这个集线器的使用权是大家抢着用的。

#### 2.2.4 MAC的封装格式

数据帧上面有两个很重要的数据，就是目标和来源的网卡卡号，

只要通过B（就是路由器）才将数据包送到另一个网段去的时候，数据帧内的网卡编号就会被改变。

数据帧内的数据内容最小要46Kbytes，因为要检测碰撞，数据帧数据总量要有64Bytes，再去掉目的地址，来源地址，校验码后，就可以得到数据量最小要有46Bytes，也就是说，如果你要传输的数据小于46Bytes，系统会主动填上一些填充码，以补全至少46Bytes的容量。

#### 2.2.5 MTU 最大传输单位

标准以太网络数据帧所能传送的数量最大可达1500bytes，这个数值就被我们称为MTU（Maximum Transmission Unit，最大传输单位）.每种网络介质的MTU都不相同,因此有的时候在某些网络文章上你会看到 1492 bytes的MTU等等. 

IP数据包最大可以达到65535 bytes, 比MTU还大,所以 IP 数据包是可以进行拆解的,然后才能放到MAC中.等数据都传到目的地,再由目的地的主机将它组装回来.所以,如果MTU能够大一些的话, 那么IP数据包的拆解情况就会降低,数据包与数据包传送之间的等待时间也会减少,就能够增加网络频宽的使用.

不论你的网络媒体支持MTU到多大，你必须要考量到你的数据包需要传到目的地时，所需要经过的所有网络媒体，然后再来决定你的MTU设置。

#### 2.2.6 集线器、交换器和相关机制

交换机和集线器最大的差异，在于交换机内有一个特别的主存，这个主存可以记录每个端口与其连接的PC的MAC的地址，所以，当来自switch两端的PC要互传数据时，每个数据帧将直接通过交换机的主存数据而传送到目的主机上。所以switch不是共享媒体，且switch的每个端口都具有独立的频宽。

交换机已经克服了数据包碰撞的问题，因为他有个switch port对应MAC的功能，所以switch不是共享媒体。

##### 全双工/半双工（full-duplex, half-duplex）

八芯的网线实际上仅有两对被使用，一对是用在传送，另一对则是在接收。如果两端的PC同时支持全双工，那表示Input/Output均可达到10/100Mbps，亦即数据的传送与接收同时均可达到10/100Mbps的意思，使用全双工时不可以使用Hub，因为网线脚的关系，无法使用共享媒体达到全双工，如果switch支持全双工的模式，那么在switch两端的PC才能达到全双工。

### 2.3 TCP/IP的网络层相关数据包与资料

要有网络的话，必须要要有网络相关的硬件，而目前最常见的网络硬件介质是以太网络，包括网线、网卡、Hub/Switch等等。而以太网络上面的传输使用网卡卡号为基准的MAC数据帧，配合CSMA/CD的标准来传送数据帧，这就是硬件部分。

在软件部分，我们知道Internet其实就是TCP/IP 这个通讯协议的通称。Internet是由InterNIC所统一管理的，但其实它仅是负责分配Internet上面的IP以及提供相关的TCP/IP技术文件而已。

这小节我们来讲讲网络层的IP和路由。

#### 2.3.1 IP数据包的封装

目前IP有两种版本，一种是IPv4,一种是IPv6. IPv4记录的地址仅有32位。IPv6有128位。

IP数据包可以达到65535 bytes 这么大，在比MAC大的情况下，我们的操作系统会对IP进行拆分，至于IP数据包的表头如下。

每一行所占用的字符数为32 bits。

`Version`：声明这个IP数据包的版本，例如目前惯用的IPv4版本就在这个字段里声明

`IHL`：（Internet Header Length, IP表头的长度）

告知这个IP数据包表头长度，使用的单位应该是`word`，一个word为`4bytes`大小

`Type of Service`: 这个项目的内容为PPPDTRUU，表示这个IP数据包的服务类型。

举例来说，gigabit以太网络的种种相关规格可以让这个IP数据包加速且降低延迟，某些特殊的标志就是在这里声明的。

`Total Length`（总长度）:

指这个IP数据包的总容量，包括表头和内容（data）部分，最大可达65535 bytes

`Identification`（识别码）

我们前面提到IP数据包必须放在MAC帧中，不过，如果IP数据包太大的话，就得先要将IP再重组成较小的包然后再放到MAC帧中。反过来重组的时候就得要有个识别码以告知接收端这些小包是来自同一个IP数据包才行。

`Flags`（特殊标识）

这个地方的内容为0DM，其含义为：

D：如果为0表示可以分段，为1表示不可分段。

M：如果为0表示此IP为最后分段，为1表示非最后分段。

`Fragment Offset`（分段偏移）

表示目前这个IP分段在原始IP数据包中所占的位置。有点像是序列号，有这个序号才能将所有的小IP分段组合成为原本的IP数据包大小。通过Total Length, Identification, Flags 以及这个Fragment Offset就能够将小IP分段在接收端组合起来。

**`Time To Live`(TTL, 存活时间)**

==表示这个IP数据包的存活时间，范围为0~255。当这个`IP`数据包通过一个路由器时，TTL就会减1，当TTL为0时，这个包将会被直接丢弃。==要让IP数据包通过255个路由器，还挺难的。

`Protocol Number`（协议代码）

来自传输层和网络层本身的其他数据都是放在IP数据包当中的，我们可以在IP表头记载这个IP数据包内的资料是什么，在这个字段就是记载每种数据包的内容。在这个字段记载的代码和相关的数据包协议名称如下所示：

| IP内的号码 |          数据包协议名称（全名）           |
| :--------: | :---------------------------------------: |
|     1      | ICMP (Internet Control Message Protocol)  |
|     2      | IGMP (Internet Group Management Protocol) |
|     3      |     GGP (Gateway-to-Gateway Protocol)     |
|     4      |        IP (IP in IP encapsulation)        |
|     6      |    TCP (Transmission Control Protocol)    |
|     8      |      EGP (Exterior Gateway Protocol)      |
|     17     |       UDP (User Datagram Protocol)        |

比较常见到的还是TCP， UDP，ICMP。

`Header Checksum`（表头校验码）

用来检查这个IP表头的错误校验之用。

`Source Address`

来源的IP地址，从这里也可以知道IP是32位字符。

`Destination Address`

目标IP地址

`Options`（其他参数）

这个是额外的功能，提供包括安全处理机制、路由记录、时间戳、严格与宽松的来源路由等。

`Padding`（补齐项目）

由于Options的内容不一定有多大，但是我们知道IP每个数据都必须要是32 bits，所以，如果Options的数据不足32 bits时，则由padding主动补齐。

只要知道IP表头里面有：`TTL`，`Protocol`，来源地址和目标地址也就够了。而这个IP表头的来源与目标IP，以及那个判断通过多少路由器的TTL，就能了解到这个IP将被如何传送到目的地端。

#### 2.3.2 IP地址的组成和分级

将32 bits的IP分成4小段，每段含有8个bits（==那么每段可以表示的范围就是0\~255==, 2的8次方为256），将8个bits计算成十进位，并且每段中间以小数点隔开，那就成了目前大家所熟悉的IP的书写模样。所以IP最小可以由0.0.0.0一直到255.255.255.255。==这一串数字中，可以分为两个部分，主要分为Net_ID（网段号码）和Host_ID(主机号码)两部分==。我们先以192.168.0.0~192.168.0.255这个Class C的网段作说明：

<u>同一个网段的定义： 在同一个物理网段内，主机的IP具有相同的Net\_ID,并且具有独特的Host\_ID</u>

物理网段指的是当所有的主机都是使用同一个网络媒体串在一起，这个时候这些主机在实体装置上其实是连线在一起的，那么就可以称为这些主机在同一个物理网段内了。同一个物理网段内，可以依据不同的IP设置，而设置成多个**IP网段**。

##### IP在同一网段的意义

* Net_ID 与 Host_ID 的限制：

	在同一个网段内，Net_ID是不变的，而Host_ID则是不可重复。此外，==Host_ID不可同时为0也不可同时为1，全为0表示网段的地址，全为1表示广播的地址（Broadcast IP）。==所以一个网段中可用来设定主机IP的数量为2^Host_ID的位数-2

* 在同一网段内通过IP广播传播数据

* 设定不同网段在相同物理网段的情况

* 网域的大小

在同物理网段的主机如果设置相同的网段IP，则这些主机都可以通过CSMA/CD的功能直接在网段内用广播进行网络连接，也就是直接网卡对网卡传输数据（通过MAC数据帧）

#### IP的分级

```shell
以二進位說明 Network 第一個數字的定義：
Class A : 0xxxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx  ==> NetI_D 的開頭是 0
          |--net--|---------host------------|
Class B : 10xxxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx  ==> NetI_D 的開頭是 10
          |------net-------|------host------|
Class C : 110xxxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx  ==> NetI_D 的開頭是 110
          |-----------net-----------|-host--|
Class D : 1110xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx  ==> NetI_D 的開頭是 1110
Class E : 1111xxxx.xxxxxxxx.xxxxxxxx.xxxxxxxx  ==> NetI_D 的開頭是 1111

五種分級在十進位的表示：
Class A :   0.xx.xx.xx ~ 127.xx.xx.xx
Class B : 128.xx.xx.xx ~ 191.xx.xx.xx
Class C : 192.xx.xx.xx ~ 223.xx.xx.xx
Class D : 224.xx.xx.xx ~ 239.xx.xx.xx
Class E : 240.xx.xx.xx ~ 255.xx.xx.xx
```



Class D 是用来作为广播的特殊功能之用，至于Class E则是保留没有使用的网段。

#### 2.3.3 IP的种类与取得方式

私有IP也分别在ABC三个Class中各保留一段作为私有IP网段

Class A: 10.0.0.0    ~ 10.255.255.255

Class B: 172.16.0.0  ~ 172.31.255.255

Class C: 192.168.0.0  ~ 192.168.255.255

这三段Class的IP是预留使用的，所以并不能直接作为Internet上面的连接使用。这三个IP网段就只作为内部私有网段的IP沟通之用。

1. 私有IP的路由信息不能对外散播（只能存在内部网络）
2. 使用私有IP作为来源或目的地址的数据包，不能通过Internet来传输
3. 关于私有IP的参考记录（如DNS），只能限于内网使用

如果想要将这些私有IP送上Internet， 设定一个简单的防火墙加上NAT服务，你就可以通过IP伪装来使你的私有IP的电脑连上Internet。

##### 特殊的loopback IP网段

还有一个奇怪的Class A 的网段，那就是lo 这个奇怪的网段。这个lo 的网络是当初被用来作为测试操作系统内部循环所用的一个网段，同时也能够提供给系统内部原本就需要使用网络接口的服务（daemon）所使用。

简单的说，如果你没有安装网卡在机器上，但是你又希望可以测试一下在你的机器上设置的服务器环境到底可不可以顺利运行，就利用这个内部loop网络。

这个网段在127.0.0.0/8 这个Class A，而且默认的主机IP是127.0.0.1.

你的主机系统mail给root，测试TCP/IP数据包状态是否正常，也可以用这个。

##### IP的取得方式

直接手动设置

通过拨号取得

自动取得网络参数（DHCP）

在局域网内会有一部主机负责管理所有的电脑的网络参数，你的网络启动时就会主动向该服务器要求IP参数，若取得网络相关参数后，你的主机就能够自行设置好所有服务器给你的网络参数了。

#### 2.3.4 Netmask, 子网与CIDR（Classless Interdomain Routing）

我们前面谈到IP是有等级的，而设置在一般电脑系统上的则是Class A, B, C。

如果我们设置一个局域网，使用的是Class A, 那么我们很容易就会想到，哪有这么多电脑可以设置在同一个Class A的网段内（256*256*256-2=16777214）？而且，假设真有这么多电脑好了，回想一下CSMA/CD吧，你的网络恐怕会一直非常停顿，因为你要接到一千多万台电脑对你的广播。

如何将网段切分的更细？

Class C的网段号码占了24位，其实我们还可以将这样的网段切的更细，就是让第一个主机ID被拿来作为网段ID，所以整个网段ID就有25 bits，而主机ID则减少为7 bits。这样的情况下，原来的一个Class C的网段就可以被切分为两个较小的网段，而每个子网段就有256/2=126个可用IP了

##### Netmask，或称为 Subnet mask

以192.168.0.0~192.168.0.255这个网段为范例

既然Net_ID是不可变的，那就假设他所占据的bits都被用光了（全是1），而Host_ID是可变的，就将他想成是保留着（全部为0），所以 Netmask就表示为

Class A, B, C 三个等级的Netmask 表示方式：

Class A: 255.0.0.0

Class B: 255.255.0.0

Class C: 255.255.255.0

当Host_ID全部是0以及全部是1的时候该IP是不可使用的，因为Host_ID全为0的时候表示该网段的Network，全为1的时候表示该网段最后一个IP，也称为Broadcast，所以，在192.168.0.0~192.168.0.255 这个IP网段里面的相关网络参数有：

Netmask:  255.255.255.0       # 网段定义中，最重要的参数

Network: 192.168.0.0		# 第一个IP

Broadcast:  192.168.0.255		# 最后一个IP

##### 子网络切分

试着计算出172.16.0.0， Net_ID 占用23个字符时，这个网段的Netmask，Network，Broadcast等参数

































### 2.4 TCP/IP 传输层相关数据包与资料

### 2.5 连上 Internet前的准备事项